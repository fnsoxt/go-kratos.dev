<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.0">
<link rel="alternate" type="application/rss+xml" href="/en/blog/rss.xml" title="Kratos Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/en/blog/atom.xml" title="Kratos Blog Atom Feed">
<script src="https://cdn.staticfile.org/pangu/4.0.7/pangu.min.js"></script>
<script src="/js/custom.js"></script><title data-react-helmet="true">Posts tagged &quot;opentelemetry&quot; | Kratos</title><meta data-react-helmet="true" property="og:title" content="Posts tagged &quot;opentelemetry&quot; | Kratos"><meta data-react-helmet="true" name="description" content="Blog | Tagged &quot;opentelemetry&quot;"><meta data-react-helmet="true" property="og:description" content="Blog | Tagged &quot;opentelemetry&quot;"><meta data-react-helmet="true" property="og:url" content="https://go-kratos.dev/en/blog/tags/open-telemetry"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_tag" content="blog_tags_posts"><meta data-react-helmet="true" name="keywords" content="Go,Kratos,OpenTracing,OpenCencus,OpenTelemetry,Google,Dapper,operation process"><link data-react-helmet="true" rel="shortcut icon" href="/en/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://go-kratos.dev/en/blog/tags/open-telemetry"><link data-react-helmet="true" rel="alternate" href="https://go-kratos.dev/blog/tags/open-telemetry" hreflang="zh"><link data-react-helmet="true" rel="alternate" href="https://go-kratos.dev/en/blog/tags/open-telemetry" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://go-kratos.dev/blog/tags/open-telemetry" hreflang="x-default"><link rel="stylesheet" href="/en/assets/css/styles.20ec9982.css">
<link rel="preload" href="/en/assets/js/runtime~main.baee257e.js" as="script">
<link rel="preload" href="/en/assets/js/main.c550a788.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#main" class="skipToContent_1oUP">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle" type="button" tabindex="0"><svg aria-label="Menu" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/en/"><img src="/en/img/logo.svg" alt="Kratos Logo" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/en/img/logo.svg" alt="Kratos Logo" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><strong class="navbar__title">Kratos</strong></a><a class="navbar__item navbar__link" href="/en/docs/">Docs</a><a href="https://pkg.go.dev/github.com/go-kratos/kratos/v2/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">API</a></div><div class="navbar__items navbar__items--right"><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/en/blog">Blog</a><a href="https://github.com/go-kratos/kratos" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub</a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" class="navbar__item navbar__link"><span><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" width="20" height="20" style="vertical-align:text-bottom;margin-right:5px"><path fill="currentColor" d="M19.753 10.909c-.624-1.707-2.366-2.726-4.661-2.726-.09 0-.176.002-.262.006l-.016-2.063 3.525-.607c.115-.019.133-.119.109-.231-.023-.111-.167-.883-.188-.976-.027-.131-.102-.127-.207-.109-.104.018-3.25.461-3.25.461l-.013-2.078c-.001-.125-.069-.158-.194-.156l-1.025.016c-.105.002-.164.049-.162.148l.033 2.307s-3.061.527-3.144.543c-.084.014-.17.053-.151.143.019.09.19 1.094.208 1.172.018.08.072.129.188.107l2.924-.504.035 2.018c-1.077.281-1.801.824-2.256 1.303-.768.807-1.207 1.887-1.207 2.963 0 1.586.971 2.529 2.328 2.695 3.162.387 5.119-3.06 5.769-4.715 1.097 1.506.256 4.354-2.094 5.98-.043.029-.098.129-.033.207l.619.756c.08.096.206.059.256.023 2.51-1.73 3.661-4.515 2.869-6.683zm-7.386 3.188c-.966-.121-.944-.914-.944-1.453 0-.773.327-1.58.876-2.156a3.21 3.21 0 011.229-.799l.082 4.277a2.773 2.773 0 01-1.243.131zm2.427-.553l.046-4.109c.084-.004.166-.01.252-.01.773 0 1.494.145 1.885.361.391.217-1.023 2.713-2.183 3.758zm-8.95-7.668a.196.196 0 00-.196-.145h-1.95a.194.194 0 00-.194.144L.008 16.916c-.017.051-.011.076.062.076h1.733c.075 0 .099-.023.114-.072l1.008-3.318h3.496l1.008 3.318c.016.049.039.072.113.072h1.734c.072 0 .078-.025.062-.076-.014-.05-3.083-9.741-3.494-11.04zm-2.618 6.318l1.447-5.25 1.447 5.25H3.226z"></path></svg><span>English</span></span></a><ul class="dropdown__menu"><li><a href="/blog/tags/open-telemetry" target="_self" rel="noopener noreferrer" class="dropdown__link" style="text-transform:capitalize">ä¸­æ–‡</a></li><li><a href="/en/blog/tags/open-telemetry" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active" style="text-transform:capitalize">English</a></li></ul></div><div class="react-toggle displayOnlyInLargeViewport_GrZ2 react-toggle--disabled" role="button" tabindex="-1"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_71bT">ğŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_71bT">ğŸŒ</span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" class="react-toggle-screenreader-only" aria-label="Switch between dark and light mode"></div><div class="navbar__search searchBarContainer_MM2z"><input placeholder="Search" aria-label="Search" class="navbar__search-input"><div class="loadingRing_s5VG searchBarLoadingRing_2jQk"><div></div><div></div><div></div><div></div></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/en/"><img src="/en/img/logo.svg" alt="Kratos Logo" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/en/img/logo.svg" alt="Kratos Logo" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><strong class="navbar__title">Kratos</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/en/docs/">Docs</a></li><li class="menu__list-item"><a href="https://pkg.go.dev/github.com/go-kratos/kratos/v2/" target="_blank" rel="noopener noreferrer" class="menu__link">API</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link navbar__link--active" href="/en/blog">Blog</a></li><li class="menu__list-item"><a href="https://github.com/go-kratos/kratos" target="_blank" rel="noopener noreferrer" class="menu__link">GitHub</a></li><li class="menu__list-item menu__list-item--collapsed"><a href="#" role="button" class="menu__link menu__link--sublist"><span><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" width="20" height="20" style="vertical-align:text-bottom;margin-right:5px"><path fill="currentColor" d="M19.753 10.909c-.624-1.707-2.366-2.726-4.661-2.726-.09 0-.176.002-.262.006l-.016-2.063 3.525-.607c.115-.019.133-.119.109-.231-.023-.111-.167-.883-.188-.976-.027-.131-.102-.127-.207-.109-.104.018-3.25.461-3.25.461l-.013-2.078c-.001-.125-.069-.158-.194-.156l-1.025.016c-.105.002-.164.049-.162.148l.033 2.307s-3.061.527-3.144.543c-.084.014-.17.053-.151.143.019.09.19 1.094.208 1.172.018.08.072.129.188.107l2.924-.504.035 2.018c-1.077.281-1.801.824-2.256 1.303-.768.807-1.207 1.887-1.207 2.963 0 1.586.971 2.529 2.328 2.695 3.162.387 5.119-3.06 5.769-4.715 1.097 1.506.256 4.354-2.094 5.98-.043.029-.098.129-.033.207l.619.756c.08.096.206.059.256.023 2.51-1.73 3.661-4.515 2.869-6.683zm-7.386 3.188c-.966-.121-.944-.914-.944-1.453 0-.773.327-1.58.876-2.156a3.21 3.21 0 011.229-.799l.082 4.277a2.773 2.773 0 01-1.243.131zm2.427-.553l.046-4.109c.084-.004.166-.01.252-.01.773 0 1.494.145 1.885.361.391.217-1.023 2.713-2.183 3.758zm-8.95-7.668a.196.196 0 00-.196-.145h-1.95a.194.194 0 00-.194.144L.008 16.916c-.017.051-.011.076.062.076h1.733c.075 0 .099-.023.114-.072l1.008-3.318h3.496l1.008 3.318c.016.049.039.072.113.072h1.734c.072 0 .078-.025.062-.076-.014-.05-3.083-9.741-3.494-11.04zm-2.618 6.318l1.447-5.25 1.447 5.25H3.226z"></path></svg><span>Languages</span></span></a><ul class="menu__list"><li class="menu__list-item"><a href="/blog/tags/open-telemetry" target="_self" rel="noopener noreferrer" class="menu__link" style="text-transform:capitalize">ä¸­æ–‡</a></li><li class="menu__list-item"><a href="/en/blog/tags/open-telemetry" target="_self" rel="noopener noreferrer" class="menu__link dropdown__link--active" style="text-transform:capitalize">English</a></li></ul></li></ul></div></div></div></nav><div class="main-wrapper blog-wrapper blog-tags-post-page"><div class="container margin-vert--lg"><div class="row"><div class="col col--3"><div class="sidebar_2ahu thin-scrollbar"><h3 class="sidebarItemTitle_2hhb">Recent posts</h3><ul class="sidebarItemList_2xAf"><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/en/blog/go-kratos-opentelemetry-practice">Kratos å­¦ä¹ ç¬”è®° - åŸºäº OpenTelemetry çš„é“¾è·¯è¿½è¸ª</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/en/blog/go-layout-operation-process">Kratos å­¦ä¹ ç¬”è®° - é€šè¿‡ layout ç®€å•åˆ†æåº”ç”¨æ˜¯å¦‚ä½•è·‘èµ·æ¥çš„</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/en/blog/go-project-layout">Goå·¥ç¨‹åŒ– - Project Layout æœ€ä½³å®è·µ</a></li></ul></div></div><main class="col col--7"><h1>One post tagged with &quot;opentelemetry&quot;</h1><a href="/en/blog/tags">View All Tags</a><div class="margin-vert--xl"><article class="margin-bottom--xl"><header><h2 class="margin-bottom--sm blogPostTitle_GeHD"><a href="/en/blog/go-kratos-opentelemetry-practice">Kratos å­¦ä¹ ç¬”è®° - åŸºäº OpenTelemetry çš„é“¾è·¯è¿½è¸ª</a></h2><div class="margin-vert--md"><time datetime="2021-06-03T00:00:00.000Z" class="blogPostDate_fNvV">June 3, 2021 Â· 5 min read</time></div><div class="avatar margin-vert--md"><a href="https://github.com/shenqidebaozi" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img src="https://avatars.githubusercontent.com/u/35397691?s=60&amp;v=4" alt="shenqidebaozi"></a><div class="avatar__intro"><h4 class="avatar__name"><a href="https://github.com/shenqidebaozi" target="_blank" rel="noopener noreferrer">shenqidebaozi</a></h4><small class="avatar__subtitle">Maintainer of go-kratos</small></div></div></header><div class="markdown"><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="é“¾è·¯è¿½è¸ªçš„å‰ä¸–ä»Šç”Ÿ"></a>é“¾è·¯è¿½è¸ªçš„å‰ä¸–ä»Šç”Ÿ<a class="hash-link" href="#é“¾è·¯è¿½è¸ªçš„å‰ä¸–ä»Šç”Ÿ" title="Direct link to heading">#</a></h2><blockquote><p>åˆ†å¸ƒå¼è·Ÿè¸ªï¼ˆä¹Ÿç§°ä¸ºåˆ†å¸ƒå¼è¯·æ±‚è·Ÿè¸ªï¼‰æ˜¯ä¸€ç§ç”¨äºåˆ†æå’Œç›‘æ§åº”ç”¨ç¨‹åºçš„æ–¹æ³•ï¼Œå°¤å…¶æ˜¯ä½¿ç”¨å¾®æœåŠ¡æ¶æ„æ„å»ºçš„åº”ç”¨ç¨‹åºã€‚åˆ†å¸ƒå¼è·Ÿè¸ªæœ‰åŠ©äºç²¾ç¡®å®šä½æ•…éšœå‘ç”Ÿçš„ä½ç½®ä»¥åŠå¯¼è‡´æ€§èƒ½å·®çš„åŸå› ã€‚   </p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="èµ·æº"></a>èµ·æº<a class="hash-link" href="#èµ·æº" title="Direct link to heading">#</a></h3><p>é“¾è·¯è¿½è¸ª(Distributed Tracing)ã€€ä¸€è¯æœ€æ—©å‡ºç°äºè°·æ­Œå‘å¸ƒçš„è®ºæ–‡ <strong>ã€ŠDapper, a Large-Scale Distributed Systems Tracing Infrastructureã€‹</strong> ä¸­,è¿™ç¯‡è®ºæ–‡å¯¹äºå®ç°é“¾è·¯è¿½è¸ª,å¯¹äºåæ¥å‡ºç°çš„ Jaegerã€Zipkin ç­‰å¼€æºåˆ†å¸ƒå¼è¿½è¸ªé¡¹ç›®è®¾è®¡ç†å¿µä»æœ‰å¾ˆæ·±çš„å½±å“ã€‚</p></blockquote><p>å¾®æœåŠ¡æ¶æ„æ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼çš„æ¶æ„,ä¼šæœ‰å¾ˆå¤šä¸ªä¸åŒçš„æœåŠ¡ã€‚ä¸åŒçš„æœåŠ¡ä¹‹å‰ç›¸äº’è°ƒç”¨,å¦‚æœå‡ºç°äº†é”™è¯¯ç”±äºä¸€ä¸ªè¯·æ±‚ç»è¿‡äº† N ä¸ªæœåŠ¡ã€‚éšç€ä¸šåŠ¡çš„å¢åŠ è¶Šæ¥è¶Šå¤šçš„æœåŠ¡ä¹‹é—´çš„è°ƒç”¨ï¼Œå¦‚æœæ²¡æœ‰ä¸€ä¸ªå·¥å…·å»è®°å½•è°ƒç”¨é“¾ï¼Œè§£å†³é—®é¢˜çš„æ—¶å€™å°±ä¼šåƒä¸‹é¢å›¾ç‰‡é‡Œå°çŒ«å’ªç©çš„æ¯›çº¿çƒä¸€æ ·ï¼Œæ¯«æ— å¤´ç»ªï¼Œæ— ä»ä¸‹æ‰‹
<img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e2dd5606765649969819396ba574a741~tplv-k3u1fbpfcp-watermark.image" alt="image.png">
æ‰€ä»¥éœ€è¦æœ‰ä¸€ä¸ªå·¥å…·èƒ½å¤Ÿæ¸…æ¥šçš„äº†è§£ä¸€ä¸ªè¯·æ±‚ç»è¿‡äº†å“ªäº›æœåŠ¡,é¡ºåºæ˜¯å¦‚ä½•,ä»è€Œèƒ½å¤Ÿè½»æ˜“çš„å®šä½é—®é¢˜ã€‚
<img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/7098634cefe74a3cbacf5e76c343bd81~tplv-k3u1fbpfcp-watermark.image" alt="image.png"></p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="ç™¾å®¶äº‰è‰³"></a>ç™¾å®¶äº‰è‰³<a class="hash-link" href="#ç™¾å®¶äº‰è‰³" title="Direct link to heading">#</a></h3><p>ä»è°·æ­Œå‘å¸ƒ <strong>Dapper</strong> åï¼Œåˆ†å¸ƒå¼é“¾è·¯è¿½è¸ªå·¥å…·è¶Šæ¥è¶Šå¤šï¼Œä»¥ä¸‹ç®€å•åˆ—ä¸¾äº†ä¸€äº›å¸¸ç”¨çš„é“¾è·¯è¿½è¸ªç³»ç»Ÿ</p><ul><li>Skywalking</li><li>é˜¿é‡Œ é¹°çœ¼</li><li>å¤§ä¼—ç‚¹è¯„ CAT</li><li>Twitter Zipkin</li><li>Naver pinpoint</li><li>Uber Jaeger</li></ul><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="äº‰é”‹ç›¸å¯¹ï¼Ÿ"></a>äº‰é”‹ç›¸å¯¹ï¼Ÿ<a class="hash-link" href="#äº‰é”‹ç›¸å¯¹ï¼Ÿ" title="Direct link to heading">#</a></h3><p>éšç€é“¾è·¯è¿½è¸ªå·¥å…·è¶Šæ¥è¶Šå¤šï¼Œå¼€æºé¢†åŸŸä¸»è¦åˆ†ä¸ºä¸¤æ´¾ï¼Œä¸€æ´¾æ˜¯ä»¥ <strong>CNCFæŠ€æœ¯å§”å‘˜</strong> ä¼šä¸ºä¸»çš„  <strong>OpenTracing</strong> çš„è§„èŒƒï¼Œä¾‹å¦‚ jaeger zipkin éƒ½æ˜¯éµå¾ªäº†<strong>OpenTracing</strong> çš„è§„èŒƒã€‚è€Œå¦ä¸€æ´¾åˆ™æ˜¯è°·æ­Œä½œä¸ºå‘èµ·è€…çš„ <strong>OpenCensus</strong>ï¼Œè€Œä¸”è°·æ­Œæœ¬èº«è¿˜æ˜¯æœ€æ—©æå‡ºé“¾è·¯è¿½è¸ªæ¦‚å¿µçš„å…¬å¸ï¼ŒåæœŸè¿å¾®è½¯ä¹ŸåŠ å…¥äº† <strong>OpenCensus</strong>
<img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/3029f1315fe34ec884858d33d41cb1ce~tplv-k3u1fbpfcp-watermark.image" alt="æˆªå±2021-05-29 ä¸‹åˆ9.56.57.png"></p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="opentelemetry-è¯ç”Ÿ"></a>OpenTelemetry è¯ç”Ÿ<a class="hash-link" href="#opentelemetry-è¯ç”Ÿ" title="Direct link to heading">#</a></h3><blockquote><p>OpenTelemetric æ˜¯ä¸€ç»„ APIã€SDKã€æ¨¡ç»„å’Œé›†æˆï¼Œä¸“ä¸ºåˆ›å»ºå’Œç®¡ç†â€â€é¥æµ‹æ•°æ®â€â€ï¼ˆå¦‚è¿½è¸ªã€æŒ‡æ ‡å’Œæ—¥å¿—ï¼‰è€Œè®¾</p></blockquote><p>å¾®è½¯åŠ å…¥ <strong>OpenCensus</strong> åï¼Œç›´æ¥æ‰“ç ´äº†ä¹‹å‰å¹³è¡¡çš„å±€é¢ï¼Œé—´æ¥çš„å¯¼è‡´äº† <strong>OpenTelemetry</strong> çš„è¯ç”Ÿ
è°·æ­Œå’Œå¾®è½¯ä¸‹å®šå†³å¿ƒç»“æŸæ±Ÿæ¹–ä¹‹ä¹±ï¼Œé¦–è¦çš„é—®é¢˜æ˜¯å¦‚ä½•æ•´åˆä¸¤ä¸ªä¸¤ä¸ªç¤¾åŒºå·²æœ‰çš„é¡¹ç›®ï¼ŒOpenTelemetry ä¸»è¦çš„ç†å¿µå°±æ˜¯ï¼Œå…¼å®¹ <strong>OpenCensus</strong> å’Œ <strong>OpenTracing</strong> ï¼Œå¯ä»¥è®©ä½¿ç”¨è€…æ— éœ€æ”¹åŠ¨æˆ–è€…å¾ˆå°çš„æ”¹åŠ¨å°±å¯ä»¥æ¥å…¥ <strong>OpenTelemetry</strong></p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="kratos-çš„é“¾è·¯è¿½è¸ªå®è·µ"></a>Kratos çš„é“¾è·¯è¿½è¸ªå®è·µ<a class="hash-link" href="#kratos-çš„é“¾è·¯è¿½è¸ªå®è·µ" title="Direct link to heading">#</a></h2><blockquote><p>Kratos ä¸€å¥—è½»é‡çº§ Go å¾®æœåŠ¡æ¡†æ¶ï¼ŒåŒ…å«å¤§é‡å¾®æœåŠ¡ç›¸å…³æ¡†æ¶åŠå·¥å…·ã€‚</p></blockquote><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="tracing-ä¸­é—´ä»¶"></a>tracing ä¸­é—´ä»¶<a class="hash-link" href="#tracing-ä¸­é—´ä»¶" title="Direct link to heading">#</a></h3><p>kratos æ¡†æ¶æä¾›çš„è‡ªå¸¦ä¸­é—´ä»¶ä¸­æœ‰ä¸€ä¸ªåä¸º <strong>tracing</strong> ä¸­é—´ä»¶ï¼Œå®ƒåŸºäº <strong>Opentelemetry</strong> å®ç°äº†kratos æ¡†æ¶çš„é“¾è·¯è¿½è¸ªåŠŸèƒ½ï¼Œä¸­é—´ä»¶çš„ä»£ç å¯ä»¥ä» <strong><a href="https://github.com/go-kratos/kratos/tree/main/middleware/tracing" target="_blank" rel="noopener noreferrer">middleware/tracing</a></strong> ä¸­çœ‹åˆ°ã€‚</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="å®ç°åŸç†"></a>å®ç°åŸç†<a class="hash-link" href="#å®ç°åŸç†" title="Direct link to heading">#</a></h4><p>kratos çš„é“¾è·¯è¿½è¸ªä¸­é—´ä»¶ç”±ä¸‰ä¸ªæ–‡ä»¶ç»„æˆ <strong>carrie.go</strong>,<strong>tracer.go</strong>,<strong>tracing.go</strong>ã€‚clientå’Œ server çš„å®ç°åŸç†åŸºæœ¬ç›¸åŒï¼Œæœ¬æ–‡ä»¥ server å®ç°è¿›è¡ŒåŸç†è§£æã€‚</p><ol><li>é¦–å…ˆå½“è¯·æ±‚è¿›å…¥æ—¶ï¼Œ<strong>tracing</strong> ä¸­é—´ä»¶ä¼šè¢«è°ƒç”¨,é¦–å…ˆè°ƒç”¨äº† <strong>tracer.go</strong> ä¸­çš„ <strong>NewTracer</strong> æ–¹æ³•</li></ol><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly golang"><div tabindex="0" class="prism-code language-golang codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">// Server returns a new server middleware for OpenTelemetry.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">func Server(opts ...Option) middleware.Middleware {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        // è°ƒç”¨ tracer.go ä¸­çš„ NewTracer ä¼ å…¥äº†ä¸€ä¸ª SpanKindServer å’Œé…ç½®é¡¹</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    tracer := NewTracer(trace.SpanKindServer, opts...)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        // ... çœç•¥ä»£ç </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><ol start="2"><li><strong>tracer.go</strong> ä¸­çš„ <strong>NewTracer</strong> æ–¹æ³•è¢«è°ƒç”¨åä¼šè¿”å›ä¸€ä¸ª <strong>Tracer</strong>,å®ç°å¦‚ä¸‹</li></ol><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly js"><div tabindex="0" class="prism-code language-js codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">func </span><span class="token function maybe-class-name" style="color:rgb(130, 170, 255)">NewTracer</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">kind trace</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access maybe-class-name">SpanKind</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> opts </span><span class="token spread operator" style="color:rgb(137, 221, 255)">...</span><span class="token maybe-class-name">Option</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token maybe-class-name">Tracer</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    options </span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> options</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword control-flow" style="font-style:italic">for</span><span class="token plain"> _</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> o </span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> range opts </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token function" style="color:rgb(130, 170, 255)">o</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token operator" style="color:rgb(137, 221, 255)">&amp;</span><span class="token plain">options</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// åˆ¤æ–­æ˜¯å¦å­˜åœ¨ otel è¿½è¸ªæä¾›è€…é…ç½®ï¼Œå¦‚æœå­˜åœ¨åˆ™è®¾ç½®</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword control-flow" style="font-style:italic">if</span><span class="token plain"> options</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access maybe-class-name">TracerProvider</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">!=</span><span class="token plain"> nil </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        otel</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token method function property-access maybe-class-name" style="color:rgb(130, 170, 255)">SetTracerProvider</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">options</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access maybe-class-name">TracerProvider</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">/*</span></div><div class="token-line" style="color:#bfc7d5"><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">        åˆ¤æ–­æ˜¯å¦å­˜åœ¨ Propagators è®¾ç½®ï¼Œå¦‚æœå­˜åœ¨è®¾ç½®åˆ™è¦†ç›–ï¼Œä¸å­˜åœ¨åˆ™è®¾ç½®ä¸€ä¸ªé»˜è®¤çš„TextMapPropagator</span></div><div class="token-line" style="color:#bfc7d5"><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">        æ³¨æ„å¦‚æœæ²¡æœ‰è®¾ç½®é»˜è®¤çš„TextMapPropagator,é“¾è·¯ä¿¡æ¯åˆ™æ— æ³•æ­£ç¡®çš„ä¼ é€’</span></div><div class="token-line" style="color:#bfc7d5"><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">        */</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword control-flow" style="font-style:italic">if</span><span class="token plain"> options</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access maybe-class-name">Propagators</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">!=</span><span class="token plain"> nil </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        otel</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token method function property-access maybe-class-name" style="color:rgb(130, 170, 255)">SetTextMapPropagator</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">options</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access maybe-class-name">Propagators</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"> </span><span class="token keyword control-flow" style="font-style:italic">else</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain">    otel</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token method function property-access maybe-class-name" style="color:rgb(130, 170, 255)">SetTextMapPropagator</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">propagation</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token method function property-access maybe-class-name" style="color:rgb(130, 170, 255)">NewCompositeTextMapPropagator</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">propagation</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access maybe-class-name">Baggage</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> propagation</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access maybe-class-name">TraceContext</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">       </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">var</span><span class="token plain"> name string</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// åˆ¤æ–­å½“å‰ä¸­é—´ä»¶çš„ç±»å‹ï¼Œæ˜¯ server è¿˜æ˜¯ client</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword control-flow" style="font-style:italic">if</span><span class="token plain"> kind </span><span class="token operator" style="color:rgb(137, 221, 255)">==</span><span class="token plain"> trace</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access maybe-class-name">SpanKindServer</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        name </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;server&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"> </span><span class="token keyword control-flow" style="font-style:italic">else</span><span class="token plain"> </span><span class="token keyword control-flow" style="font-style:italic">if</span><span class="token plain"> kind </span><span class="token operator" style="color:rgb(137, 221, 255)">==</span><span class="token plain"> trace</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access maybe-class-name">SpanKindClient</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        name </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;client&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"> </span><span class="token keyword control-flow" style="font-style:italic">else</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token function" style="color:rgb(130, 170, 255)">panic</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">fmt</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token method function property-access maybe-class-name" style="color:rgb(130, 170, 255)">Sprintf</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;unsupported span kind: %v&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> kind</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// è°ƒç”¨ otelåŒ…çš„ Tracer æ–¹æ³• ä¼ å…¥ name ç”¨æ¥åˆ›å»ºä¸€ä¸ª tracer å®ä¾‹</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    tracer </span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> otel</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token method function property-access maybe-class-name" style="color:rgb(130, 170, 255)">Tracer</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword control-flow" style="font-style:italic">return</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">&amp;</span><span class="token maybe-class-name">Tracer</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain">tracer</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> tracer</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> kind</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> kind</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><ol start="3"><li>åˆ¤æ–­å½“å‰è¯·æ±‚ç±»å‹ï¼Œå¤„ç†éœ€è¦é‡‡é›†çš„æ•°æ®ï¼Œå¹¶è°ƒç”¨ <strong>tracer.go</strong> ä¸­çš„ <strong>Start</strong> æ–¹æ³•</li></ol><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly golang"><div tabindex="0" class="prism-code language-golang codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">            var (</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                component string</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                operation string</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                carrier   propagation.TextMapCarrier</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            )</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            // åˆ¤æ–­è¯·æ±‚ç±»å‹</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            if info, ok := http.FromServerContext(ctx); ok {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                // HTTP</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                component = &quot;HTTP&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                // å–å‡ºè¯·æ±‚çš„åœ°å€</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                operation = info.Request.RequestURI</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                // è°ƒç”¨ otel/propagationåŒ…ä¸­çš„ HeaderCarrierï¼Œä¼šå¤„ç† http.Header ä»¥ç”¨æ¥æ»¡è¶³TextMapCarrier interface</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                // TextMapCarrier æ˜¯ä¸€ä¸ªæ–‡æœ¬æ˜ å°„è½½ä½“ï¼Œç”¨äºæ‰¿è½½ä¿¡æ¯</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                carrier = propagation.HeaderCarrier(info.Request.Header)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                // otel.GetTextMapPropagator().Extract() æ–¹æ³•ç”¨äºå°†æ–‡æœ¬æ˜ å°„è½½ä½“ï¼Œè¯»å–åˆ°ä¸Šä¸‹æ–‡ä¸­</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                ctx = otel.GetTextMapPropagator().Extract(ctx, propagation.HeaderCarrier(info.Request.Header))</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            } else if info, ok := grpc.FromServerContext(ctx); ok {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                // Grpc</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                component = &quot;gRPC&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                operation = info.FullMethod</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                //</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                // è°ƒç”¨ grpc/metadataåŒ…ä¸­metadata.FromIncomingContext(ctx)ä¼ å…¥ ctxï¼Œè½¬æ¢ grpc çš„å…ƒæ•°æ®</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                if md, ok := metadata.FromIncomingContext(ctx); ok {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    // è°ƒç”¨carrier.go ä¸­çš„ MetadataCarrier å°† MD è½¬æ¢ æˆæ–‡æœ¬æ˜ å°„è½½ä½“</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    carrier = MetadataCarrier(md)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                        // è°ƒç”¨ tracer.Start æ–¹æ³•</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            ctx, span := tracer.Start(ctx, component, operation, carrier)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                        // ... çœç•¥ä»£ç </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><ol start="4"><li>è°ƒç”¨ <strong>tracing.go</strong> ä¸­çš„ <strong>Start</strong> æ–¹æ³•</li></ol><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly golang"><div tabindex="0" class="prism-code language-golang codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">func (t *Tracer) Start(ctx context.Context, component string, operation string, carrier propagation.TextMapCarrier) (context.Context, trace.Span) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    // åˆ¤æ–­å½“å‰ä¸­é—´ä»¶å¦‚æœæ˜¯ serveråˆ™å°† carrier æ³¨å…¥åˆ°ä¸Šä¸‹æ–‡ä¸­</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    if t.kind == trace.SpanKindServer {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        ctx = otel.GetTextMapPropagator().Extract(ctx, carrier)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    // è°ƒç”¨otel/tracer åŒ…ä¸­çš„ start æ–¹æ³•ï¼Œç”¨æ¥åˆ›å»ºä¸€ä¸ª span</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    ctx, span := t.tracer.Start(ctx,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        // tracing.go ä¸­å£°æ˜çš„è¯·æ±‚è·¯ç”±ä½œä¸º spanName</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        operation,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        // è®¾ç½® span çš„å±æ€§ï¼Œè®¾ç½®äº†ä¸€ä¸ª componentï¼Œcomponentçš„å€¼ä¸ºè¯·æ±‚ç±»å‹</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        trace.WithAttributes(attribute.String(&quot;component&quot;, component)),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        // è®¾ç½® spanç§ç±»</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        trace.WithSpanKind(t.kind),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    )</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    // åˆ¤æ–­å¦‚æœå½“å‰ä¸­é—´ä»¶æ˜¯ client åˆ™å°† carrier æ³¨å…¥åˆ°è¯·æ±‚é‡Œé¢</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    if t.kind == trace.SpanKindClient {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        otel.GetTextMapPropagator().Inject(ctx, carrier)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    return ctx, span</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><ol start="5"><li><strong>defer</strong> å£°æ˜äº†ä¸€ä¸ªé—­åŒ…æ–¹æ³•</li></ol><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly golang"><div tabindex="0" class="prism-code language-golang codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">// è¿™ä¸ªåœ°æ–¹è¦æ³¨æ„ï¼Œéœ€è¦ä½¿ç”¨é—­åŒ…ï¼Œå› ä¸º defer çš„å‚æ•°æ˜¯å®æ—¶è®¡ç®—çš„å¦‚æœå¼‚å¸¸å‘ç”Ÿï¼Œerr ä¼šä¸€ç›´ä¸º nil</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">// https://github.com/go-kratos/kratos/issues/927</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">defer func() { tracer.End(ctx, span, err) }()</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><ol start="6"><li>ä¸­é—´ä»¶ç»§ç»­æ‰§è¡Œ</li></ol><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly golang"><div tabindex="0" class="prism-code language-golang codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">// tracing.go 69è¡Œ</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">reply, err = handler(ctx, req)</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><ol start="7"><li>ä¸­é—´ä»¶è°ƒç”¨ç»“æŸ <strong>defer</strong> ä¸­çš„é—­åŒ…è¢«è°ƒç”¨åæ‰§è¡Œäº† <strong>tracer.go</strong> ä¸­çš„ <strong>End</strong> æ–¹æ³•</li></ol><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly golang"><div tabindex="0" class="prism-code language-golang codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">func (t *Tracer) End(ctx context.Context, span trace.Span, err error) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    // åˆ¤æ–­æ˜¯å¦æœ‰å¼‚å¸¸å‘ç”Ÿï¼Œå¦‚æœæœ‰åˆ™è®¾ç½®ä¸€äº›å¼‚å¸¸ä¿¡æ¯</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    if err != nil {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        // è®°å½•å¼‚å¸¸</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        span.RecordError(err)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        // è®¾ç½®span å±æ€§</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        span.SetAttributes(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            // è®¾ç½®äº‹ä»¶ä¸ºå¼‚å¸¸</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            attribute.String(&quot;event&quot;, &quot;error&quot;),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            // è®¾ç½® message ä¸º err.Error().</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            attribute.String(&quot;message&quot;, err.Error()),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        )</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        //è®¾ç½®äº† span çš„çŠ¶æ€</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        span.SetStatus(codes.Error, err.Error())</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    } else {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        // å¦‚æœæ²¡æœ‰å‘ç”Ÿå¼‚å¸¸ï¼Œspan çŠ¶æ€åˆ™ä¸º ok</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        span.SetStatus(codes.Ok, &quot;OK&quot;)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    // ä¸­æ­¢ span</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    span.End()</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="å¦‚ä½•ä½¿ç”¨"></a>å¦‚ä½•ä½¿ç”¨<a class="hash-link" href="#å¦‚ä½•ä½¿ç”¨" title="Direct link to heading">#</a></h4><p>tracing ä¸­é—´ä»¶çš„ä½¿ç”¨ç¤ºä¾‹å¯ä»¥ä»  <a href="https://github.com/go-kratos/kratos/tree/main/examples/traces" target="_blank" rel="noopener noreferrer">kratos/examples/traces</a> ,è¯¥ç¤ºä¾‹ç®€å•çš„å®ç°äº†è·¨æœåŠ¡é—´çš„é“¾è·¯è¿½è¸ª,ä»¥ä¸‹ä»£ç ç‰‡æ®µåŒ…å«éƒ¨åˆ†ç¤ºä¾‹ä»£ç ã€‚</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly golang"><div tabindex="0" class="prism-code language-golang codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">// https://github.com/go-kratos/kratos/blob/7f835db398c9d0332e69b81bad4c652b4b45ae2e/examples/traces/app/message/main.go#L38</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">// é¦–å…ˆè°ƒç”¨otel åº“æ–¹æ³•ï¼Œå¾—åˆ°ä¸€ä¸ª TracerProvider</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">func tracerProvider(url string) (*tracesdk.TracerProvider, error) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    // examples/traces ä¸­ä½¿ç”¨çš„æ˜¯ jaegerï¼Œå…¶ä»–æ–¹å¼å¯ä»¥æŸ¥çœ‹ opentelemetry å®˜æ–¹ç¤ºä¾‹</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    exp, err := jaeger.NewRawExporter(jaeger.WithCollectorEndpoint(jaeger.WithEndpoint(url)))</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    if err != nil {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        return nil, err</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    tp := tracesdk.NewTracerProvider(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        tracesdk.WithSampler(tracesdk.AlwaysSample()),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        // è®¾ç½® Batcherï¼Œæ³¨å†Œjaegerå¯¼å‡ºç¨‹åº</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        tracesdk.WithBatcher(exp),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        // è®°å½•ä¸€äº›é»˜è®¤ä¿¡æ¯</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        tracesdk.WithResource(resource.NewWithAttributes(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            semconv.ServiceNameKey.String(pb.User_ServiceDesc.ServiceName),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            attribute.String(&quot;environment&quot;, &quot;development&quot;),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            attribute.Int64(&quot;ID&quot;, 1),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        )),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    )</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    return tp, nil</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="åœ¨-grpcserver-ä¸­ä½¿ç”¨"></a>åœ¨ grpc/server ä¸­ä½¿ç”¨<a class="hash-link" href="#åœ¨-grpcserver-ä¸­ä½¿ç”¨" title="Direct link to heading">#</a></h4><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly golang"><div tabindex="0" class="prism-code language-golang codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">// https://github.com/go-kratos/kratos/blob/main/examples/traces/app/message/main.go</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    grpcSrv := grpc.NewServer(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        grpc.Address(&quot;:9000&quot;),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        grpc.Middleware(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            middleware.Chain(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                recovery.Recovery(),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                // Configuring tracing Middleware</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                tracing.Server(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    tracing.WithTracerProvider(tp),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    ),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                ),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                logging.Server(logger),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            ),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        ))</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="åœ¨-grpcclient-ä¸­ä½¿ç”¨"></a>åœ¨ grpc/client ä¸­ä½¿ç”¨<a class="hash-link" href="#åœ¨-grpcclient-ä¸­ä½¿ç”¨" title="Direct link to heading">#</a></h4><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly golang"><div tabindex="0" class="prism-code language-golang codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">// https://github.com/go-kratos/kratos/blob/149fc0195eb62ee1fbc2728adb92e1bcd1a12c4e/examples/traces/app/user/main.go#L63</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    conn, err := grpc.DialInsecure(ctx,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        grpc.WithEndpoint(&quot;127.0.0.1:9000&quot;),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        grpc.WithMiddleware(middleware.Chain(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            tracing.Client(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                tracing.WithTracerProvider(s.tracer),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                tracing.WithPropagators(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    propagation.NewCompositeTextMapPropagator(propagation.Baggage{}, propagation.TraceContext{}),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                ),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            ),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            recovery.Recovery())),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        grpc.WithTimeout(2*time.Second),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    )</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="åœ¨-httpserver-ä¸­ä½¿ç”¨"></a>åœ¨ http/server ä¸­ä½¿ç”¨<a class="hash-link" href="#åœ¨-httpserver-ä¸­ä½¿ç”¨" title="Direct link to heading">#</a></h4><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly golang"><div tabindex="0" class="prism-code language-golang codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">// https://github.com/go-kratos/kratos/blob/main/examples/traces/app/user/main.go</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    httpSrv := http.NewServer(http.Address(&quot;:8000&quot;))</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    httpSrv.HandlePrefix(&quot;/&quot;, pb.NewUserHandler(s,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        http.Middleware(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            middleware.Chain(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                recovery.Recovery(),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                // Configuring tracing middleware</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                tracing.Server(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    tracing.WithTracerProvider(tp),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    tracing.WithPropagators(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                        propagation.NewCompositeTextMapPropagator(propagation.Baggage{}, propagation.TraceContext{}),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    ),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                ),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                logging.Server(logger),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            ),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        )),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    )</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="åœ¨-httpclient-ä¸­ä½¿ç”¨"></a>åœ¨ http/client ä¸­ä½¿ç”¨<a class="hash-link" href="#åœ¨-httpclient-ä¸­ä½¿ç”¨" title="Direct link to heading">#</a></h4><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly golang"><div tabindex="0" class="prism-code language-golang codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">    http.NewClient(ctx, http.WithMiddleware(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        tracing.Client(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            tracing.WithTracerProvider(s.tracer),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        ),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    ))</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="å¦‚ä½•å®ç°ä¸€ä¸ªå…¶ä»–åœºæ™¯çš„-tracing"></a>å¦‚ä½•å®ç°ä¸€ä¸ªå…¶ä»–åœºæ™¯çš„ tracing<a class="hash-link" href="#å¦‚ä½•å®ç°ä¸€ä¸ªå…¶ä»–åœºæ™¯çš„-tracing" title="Direct link to heading">#</a></h4><p>æˆ‘ä»¬å¯ä»¥å€Ÿé‰´ <strong>kratos</strong> çš„ <strong>tracing</strong> ä¸­é—´ä»¶çš„ä»£ç æ¥å®ç°ä¾‹å¦‚æ•°æ®åº“çš„ <strong>tracing</strong>ï¼Œå¦‚ä¸‹é¢çš„ä»£ç ç‰‡æ®µï¼Œä½œè€…å€Ÿé‰´äº†<strong>tracing</strong> ä¸­é—´ä»¶ï¼Œå®ç°äº† <strong>qmgo</strong> åº“æ“ä½œ <strong>MongoDB</strong> æ•°æ®åº“çš„ <strong>tracing</strong>ã€‚</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly golang"><div tabindex="0" class="prism-code language-golang codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">func mongoTracer(ctx context.Context,tp trace.TracerProvider, command interface{}) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    otel.SetTracerProvider(tp)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    var (</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        commandName string</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        failure     string</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        nanos       int64</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        reply       bson.Raw</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        queryId     int64</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        eventName   string</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    )</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    reply = bson.Raw{}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    switch value := command.(type) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    case *event.CommandStartedEvent:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        commandName = value.CommandName</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        reply = value.Command</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        queryId = value.RequestID</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        eventName = &quot;CommandStartedEvent&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    case *event.CommandSucceededEvent:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        commandName = value.CommandName</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        nanos = value.DurationNanos</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        queryId = value.RequestID</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        eventName = &quot;CommandSucceededEvent&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    case *event.CommandFailedEvent:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        commandName = value.CommandName</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        failure = value.Failure</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        nanos = value.DurationNanos</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        queryId = value.RequestID</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        eventName = &quot;CommandFailedEvent&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    duration, _ := time.ParseDuration(strconv.FormatInt(nanos, 10) + &quot;ns&quot;)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    tracer := otel.Tracer(&quot;mongodb&quot;)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    kind := trace.SpanKindServer</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    ctx, span := tracer.Start(ctx,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        commandName,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        trace.WithAttributes(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            attribute.String(&quot;event&quot;, eventName),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            attribute.String(&quot;command&quot;, commandName),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            attribute.String(&quot;query&quot;, reply.String()),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            attribute.Int64(&quot;queryId&quot;, queryId),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            attribute.String(&quot;ms&quot;, duration.String()),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        ),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        trace.WithSpanKind(kind),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    )</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    if failure != &quot;&quot; {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        span.RecordError(errors.New(failure))</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    span.End()</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="å‚è€ƒæ–‡çŒ®"></a>å‚è€ƒæ–‡çŒ®<a class="hash-link" href="#å‚è€ƒæ–‡çŒ®" title="Direct link to heading">#</a></h2><ul><li><a href="https://www.researchgate.net/publication/239595848_Dapper_a_Large-Scale_Distributed_Systems_Tracing_Infrastructure" target="_blank" rel="noopener noreferrer">è°·æ­Œè®ºæ–‡ã€ŠDapper, a Large-Scale Distributed Systems Tracing Infrastructureã€‹</a></li><li><a href="https://opentelemetry.io/" target="_blank" rel="noopener noreferrer">OpenTelemetry å®˜ç½‘</a></li><li><a href="https://static.sched.com/hosted_files/kccncosschn19chi/03/OpenTelemetry_%20Overview%20%26%20Backwards%20Compatibility%20of%20OpenTracing%20%2B%20OpenCensus%20-%20Steve%20Flanders%2C%20Omnition.pdf" target="_blank" rel="noopener noreferrer">KubeCon2019 OpenTelemetryåˆ†äº«</a></li><li><a href="https://go-kratos.dev/docs/getting-started/start" target="_blank" rel="noopener noreferrer">Kratos æ¡†æ¶</a></li><li><a href="https://github.com/go-kratos/kratos/tree/main/examples/traces" target="_blank" rel="noopener noreferrer">traces ç¤ºä¾‹</a></li></ul></div><footer class="row margin-vert--lg"><div class="col"><strong>Tags:</strong><a class="margin-horiz--sm" href="/en/blog/tags/go">go</a><a class="margin-horiz--sm" href="/en/blog/tags/golang">golang</a><a class="margin-horiz--sm" href="/en/blog/tags/é“¾è·¯è¿½è¸ª">é“¾è·¯è¿½è¸ª</a><a class="margin-horiz--sm" href="/en/blog/tags/open-telemetry">OpenTelemetry</a><a class="margin-horiz--sm" href="/en/blog/tags/æºç åˆ†æ">æºç åˆ†æ</a></div><div class="col text--right"><a aria-label="Read more about Kratos å­¦ä¹ ç¬”è®° - åŸºäº OpenTelemetry çš„é“¾è·¯è¿½è¸ª" href="/en/blog/go-kratos-opentelemetry-practice"><strong>Read More</strong></a></div></footer></article></div></main></div></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><h4 class="footer__title">Docs</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/en/docs/">Guides</a></li><li class="footer__item"><a href="http://v1.go-kratos.dev/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Kratos v1(legacy)</a></li><li class="footer__item"><a href="https://github.com/go-kratos/go-kratos.dev" target="_blank" rel="noopener noreferrer" class="footer__link-item">Docs Repo</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">Community</h4><ul class="footer__items"><li class="footer__item"><a href="https://discord.gg/BWzJsUJ" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">More</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/en/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/go-kratos/kratos" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2021 go-kratos.dev</div></div></div></footer></div>
<script src="/en/assets/js/runtime~main.baee257e.js"></script>
<script src="/en/assets/js/main.c550a788.js"></script>
</body>
</html>